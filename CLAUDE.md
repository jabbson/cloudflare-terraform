# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Terraform project managing Cloudflare DNS, Zero Trust Tunnels, and Email Routing for the `jabbson.xyz` domain. Uses Cloudflare provider v5 (`~> 5`) and requires Terraform >= 1.5.0.

## Required Environment Variables

Credentials are stored in `.env` (gitignored). Copy `.env.example` to `.env` and fill in all three values. Source it before running any command:

```bash
source .env
```

All three variables are required — `generate.sh` will fail immediately if any are missing:
- `CLOUDFLARE_API_TOKEN` — Bearer token, also the only env var read by the Cloudflare provider
- `ZONE_ID` — Cloudflare zone ID for the domain
- `ACCOUNT_ID` — Cloudflare account ID

`zone_id` and `account_id` are also required Terraform variables — they are written into `dns.auto.tfvars.json` / `tunnels.auto.tfvars.json` by `generate.sh` and loaded automatically from there.

## Workflow

All `*.auto.tfvars.json` files and `imports.tf` are **generated artifacts** — do not edit them by hand.

```bash
# 0. Load credentials
source .env

# 1. Sync state from Cloudflare API → regenerate tfvars + imports
./generate.sh

# 2. Standard Terraform workflow (init only needed once or after provider changes)
terraform init
terraform plan
terraform apply
```

### Resetting state (after major refactors or to re-import everything clean)

```bash
rm -f terraform.tfstate terraform.tfstate.backup
source .env && ./generate.sh
terraform apply   # re-imports all 46 resources from live Cloudflare state
```

`generate.sh` fetches live state from the Cloudflare API and writes:
- `dns.auto.tfvars.json` — all DNS records
- `tunnels.auto.tfvars.json` — Zero Trust tunnels
- `email_routing.auto.tfvars.json` — email routing rules, addresses, catch-all
- `imports.tf` — import blocks for every resource (regenerated each run)

## Architecture

**Flat root module** — no submodules. All resources live in the root.

| File | Purpose |
|------|---------|
| `providers.tf` | Cloudflare provider, auth via env vars |
| `variables.tf` | Input variable declarations |
| `dns.tf` | `cloudflare_dns_record.this` (for_each over `dns_records` map) |
| `tunnels.tf` | `cloudflare_zero_trust_tunnel_cloudflared.this` (for_each over `tunnels` map) |
| `email_routing.tf` | Email routing settings, addresses, rules, catch-all |
| `imports.tf` | Auto-generated import blocks — regenerated by `generate.sh` |
| `generate.sh` | Calls Cloudflare API and writes all `*.auto.tfvars.json` + `imports.tf` |
| `traefik.auto.tfvars` | Sets `traefik_ip` (hand-managed, not regenerated, gitignored — copy from `traefik.auto.tfvars.example`) |

## Key Design Patterns

**Traefik IP injection**: `dns.tf` uses a local to override the `content` of any A record tagged with `comment = "traefik"` with `var.traefik_ip` from `traefik.auto.tfvars`. This file is gitignored (contains real server IP) — copy `traefik.auto.tfvars.example` to `traefik.auto.tfvars` and set the real IP. Update it when the Traefik host IP changes.

**Import-based management**: Resources are imported from Cloudflare rather than created fresh. `imports.tf` is regenerated on every `generate.sh` run and covers all DNS records, tunnels, email routing addresses, rules, and the catch-all.

**Prevent destroy**: All resources have `lifecycle { prevent_destroy = true }`. Removing a resource requires removing both the resource block and this lifecycle protection.

**Email routing variable types**: `email_routing_rules` uses `map(object({...}))` with `optional()` fields throughout. This is intentional — forward rules have `actions[].value` and `matchers[].field/value`, but drop-action rules and the all-matcher do not. Using `optional()` lets Terraform normalize the shapes without type errors. Do not change this to `map(any)`.

**Email routing catch-all**: The Cloudflare API returns the catch-all inside the `/email/routing/rules` list (type=all matcher, priority=2147483647). `generate.sh` filters it out and writes it separately. It is managed by `cloudflare_email_routing_catch_all`, not `cloudflare_email_routing_rule`.

**Resource ID patterns**:
- DNS records: `zone_id/record_id`
- Tunnels: `account_id/tunnel_id`
- Email addresses: `account_id/address_id`
- Email rules: `zone_id/rule_id`
- Catch-all: `zone_id`
